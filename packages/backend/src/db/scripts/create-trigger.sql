CREATE FUNCTION public.update_order_progress() RETURNS trigger AS $$ LANGUAGE plpgsql BEGIN UPDATE orders SET progress = ROUND(CAST(COUNT(*) FILTER (WHERE picked_quantity >= quantity) AS FLOAT) / NULLIF(COUNT(*) FROM order_items WHERE order_id = orders.order_id), 0) * 100), updated_at = NOW() FROM orders WHERE orders.order_id IN (SELECT oi.order_id FROM order_items oi WHERE oi.order_id = orders.order_id); END; $$; CREATE TRIGGER trigger_update_order_progress AFTER INSERT OR UPDATE ON order_items FOR EACH ROW EXECUTE FUNCTION public.update_order_progress();