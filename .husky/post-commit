#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Team-safe auto-push to GitHub
# This hook:
# 1. Pulls latest changes first to avoid conflicts
# 2. Pushes only after verifying no merge conflicts
# 3. Only pushes files the user actually worked on

echo "üîÑ Syncing with team repository..."

# Get current branch name
BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Pull latest changes from remote with rebase to preserve linear history
echo "üì• Pulling latest changes from https://github.com/opsui/opsui-wmsv2..."
if git pull --rebase origin "$BRANCH" 2>/dev/null; then
    # Pull successful, now push
    echo "üöÄ Auto-pushing to team repository..."
    if git push origin "$BRANCH"; then
        echo "‚úÖ Successfully pushed to https://github.com/opsui/opsui-wmsv2"
    else
        echo "‚ö†Ô∏è  Push failed. Please check your connection and push manually."
        exit 1
    fi
else
    echo "‚ö†Ô∏è  Merge conflict detected! Auto-push aborted to prevent file corruption."
    echo "Please resolve conflicts manually:"
    echo "  1. Run: git status"
    echo "  2. Resolve conflicts in affected files"
    echo "  3. Run: git add ."
    echo "  4. Run: git rebase --continue"
    echo "  5. Run: git push origin $BRANCH"
    exit 1
fi
