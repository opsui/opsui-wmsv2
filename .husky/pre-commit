#!/bin/bash
# Pre-commit hook for quality checks
# This script runs before each commit to ensure code quality

set -e

echo "üîç Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_success() {
  echo -e "${GREEN}‚úì $1${NC}"
}

print_error() {
  echo -e "${RED}‚úó $1${NC}"
}

print_warning() {
  echo -e "${YELLOW}‚ö† $1${NC}"
}

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "No TypeScript/JavaScript files staged. Skipping checks."
  exit 0
fi

echo "Staged files:"
echo "$STAGED_FILES"
echo ""

# 1. Format check with Prettier
echo "üìù Checking code formatting..."
if ! npx prettier --check $STAGED_FILES 2>/dev/null; then
  print_error "Code formatting issues found!"
  echo "Run 'npm run format:fix' to auto-fix."
  echo ""
  echo "Files with formatting issues:"
  npx prettier --check $STAGED_FILES 2>&1 | grep "Code style issues" || true
  exit 1
fi
print_success "Code formatting is correct"

# 2. Lint with ESLint
echo "üîé Running ESLint..."
# Filter out files that are ignored by ESLint to avoid warnings
LINTABLE_FILES=""
for FILE in $STAGED_FILES; do
  if npx eslint "$FILE" 2>&1 | grep -q "File ignored"; then
    # Skip ignored files
    continue
  fi
  LINTABLE_FILES="$LINTABLE_FILES $FILE"
done

if [ -n "$LINTABLE_FILES" ]; then
  if ! npx eslint $LINTABLE_FILES --quiet; then
    print_error "ESLint errors found!"
    echo "Run 'npm run lint:fix' to attempt auto-fix."
    exit 1
  fi
fi
print_success "ESLint passed"

# 3. TypeScript type check
echo "üî∑ Checking TypeScript types..."
cd packages/backend
if ! npx tsc --noEmit --pretty false 2>&1 | grep -q "error TS"; then
  print_error "TypeScript errors found!"
  exit 1
fi
print_success "TypeScript types are valid"
cd ../..

# 4. Check for unused exports
echo "üóëÔ∏è  Checking for unused exports..."
if ! npm run check:unused 2>/dev/null; then
  print_warning "Unused exports detected. Consider removing them."
  # Don't fail on this, just warn
fi
print_success "No unused exports"

# 5. Check file sizes
echo "üìè Checking file sizes..."
MAX_FILE_SIZE_LINES=500
for FILE in $STAGED_FILES; do
  if [ -f "$FILE" ]; then
    LINES=$(wc -l < "$FILE" | tr -d ' ')
    if [ "$LINES" -gt "$MAX_FILE_SIZE_LINES" ]; then
      print_warning "$FILE has $LINES lines (max: $MAX_FILE_SIZE_LINES)"
    fi
  fi
done
print_success "File sizes acceptable"

# 6. Check for console.log/staging files
echo "üö´ Checking for prohibited patterns..."
PROHIBITED_PATTERNS=(
  "console\.log"
  "console\.debug"
  "TODO:"
  "FIXME:"
  "HACK:"
  "XXX:"
)

for PATTERN in "${PROHIBITED_PATTERNS[@]}"; do
  MATCHES=$(grep -rn "$PATTERN" $STAGED_FILES 2>/dev/null || true)
  if [ -n "$MATCHES" ]; then
    print_warning "Found $PATTERN in staged files:"
    echo "$MATCHES"
  fi
done

# 7. Run tests for affected files
echo "üß™ Running tests for affected files..."
TEST_FAILED=0
for FILE in $STAGED_FILES; do
  # Find corresponding test file
  TEST_FILE=$(echo "$FILE" | sed 's/\.ts$/.test.ts/' | sed 's/\.tsx$/.test.tsx/')

  if [ -f "$TEST_FILE" ]; then
    PACKAGE_DIR=$(dirname "$FILE" | cut -d'/' -f1-2)
    if [ -d "$PACKAGE_DIR" ]; then
      echo "  Running tests for $TEST_FILE"
      cd "$PACKAGE_DIR"
      if ! npm test -- "$TEST_FILE" --passWithNoTests 2>&1 | grep -q "FAIL"; then
        print_error "Tests failed for $TEST_FILE"
        TEST_FAILED=1
      fi
      cd - > /dev/null
    fi
  fi
done

if [ $TEST_FAILED -eq 0 ]; then
  print_success "Tests passed"
fi

# Final summary
echo ""
echo -e "${GREEN}‚úì All pre-commit checks passed!${NC}"
echo ""
echo "Committing..."
exit 0
