name: WMS Crawler Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  BASE_URL: 'http://localhost:5173'

jobs:
  crawl:
    name: Run Crawler Tests
    timeout-minutes: 60

    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: wms_user
          POSTGRES_PASSWORD: wms_password
          POSTGRES_DB: wms_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Playwright
        run: npx playwright install --with-deps chromium

      - name: Build backend
        run: npm run build --workspace=packages/backend

      - name: Build shared package
        run: npm run build --workspace=packages/shared

      - name: Build frontend
        run: npm run build --workspace=packages/frontend

      - name: Seed test data
        run: |
          echo "Seeding test database..."
          # Add your seed commands here
          # npm run db:seed

      - name: Start dev server
        run: |
          npm run dev &
          echo "Waiting for servers to start..."

          # Wait for backend (port 3000)
          echo "Waiting for backend on port 3000..."
          for i in {1..30}; do
            if curl -s http://localhost:3000/health > /dev/null 2>&1 || curl -s http://localhost:3000 > /dev/null 2>&1; then
              echo "Backend is ready!"
              break
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done

          # Wait for frontend (port 5173)
          echo "Waiting for frontend on port 5173..."
          for i in {1..30}; do
            if curl -s http://localhost:5173 > /dev/null 2>&1; then
              echo "Frontend is ready!"
              break
            fi
            echo "Waiting for frontend... ($i/30)"
            sleep 2
          done

      - name: Run Playwright Crawler
        run: npm run crawl
        continue-on-error: true

      - name: Normalize errors
        run: npm run crawl:normalize
        continue-on-error: true

      - name: Upload error log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: error-log
          path: ai-loop/error-log.json
          retention-days: 7

      - name: Upload normalized report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: normalized-errors
          path: ai-loop/normalized-errors.json
          retention-days: 30

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: ai-loop/playwright-report
          retention-days: 7

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshots
          path: ai-loop/test-results
          retention-days: 7

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'ai-loop/normalized-errors.json';

            let comment = '## üï∑Ô∏è WMS Crawler Results\n\n';

            if (fs.existsSync(reportPath)) {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));

              comment += '### üìä Summary\n';
              comment += `- **Duration**: ${Math.round(report.duration / 1000)}s\n`;
              comment += `- **Unique Errors**: ${report.summary.totalUniqueErrors}\n`;
              comment += `- **API Issues**: ${report.summary.totalAPIIssues}\n`;
              comment += `- **Coverage**: ${report.coverage.routeCoverage}% routes, ${report.coverage.elementStats.interactionCoverage}% elements\n\n`;

              if (report.summary.totalUniqueErrors > 0) {
                comment += '### üö® Top Errors\n\n';
                for (const err of report.errors.slice(0, 5)) {
                  comment += `**[${err.id}] ${err.type}** (${err.priority})\n`;
                  comment += `- Routes: ${err.routes.slice(0, 2).join(', ')}\n`;
                  comment += `- Message: \`${err.message.slice(0, 80)}...\`\n`;
                  if (err.suggestedFix) {
                    comment += `- Fix: ${err.suggestedFix}\n`;
                  }
                  comment += '\n';
                }
              } else {
                comment += '### ‚úÖ No Errors Found!\n\n';
              }
            } else {
              comment += '‚ö†Ô∏è Error report not generated. Check the logs.\n';
            }

            comment += '\nüìÅ Full reports available in workflow artifacts.';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail on critical errors
        run: |
          if [ -f "ai-loop/normalized-errors.json" ]; then
            CRITICAL=$(node -e "
              const report = require('./ai-loop/normalized-errors.json');
              console.log(report.summary.byPriority.critical || 0);
            ")
            if [ "$CRITICAL" -gt 0 ]; then
              echo "‚ùå Found $CRITICAL critical error(s)"
              exit 1
            fi
          fi
